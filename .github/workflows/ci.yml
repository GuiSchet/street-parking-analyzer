name: CI Pipeline

on:
  push:
    branches: [ main, develop, 'claude/**' ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:

jobs:
  project-structure:
    runs-on: ubuntu-latest
    name: Verify Project Structure

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Verify project structure
        run: |
          echo "Checking project structure..."
          test -d backend && echo "✓ Backend directory exists" || (echo "✗ Backend directory missing" && exit 1)
          test -d frontend && echo "✓ Frontend directory exists" || (echo "✗ Frontend directory missing" && exit 1)
          test -f backend/requirements.txt && echo "✓ Backend requirements.txt exists" || (echo "✗ Backend requirements.txt missing" && exit 1)
          test -f frontend/package.json && echo "✓ Frontend package.json exists" || (echo "✗ Frontend package.json missing" && exit 1)
          test -f CLAUDE.md && echo "✓ CLAUDE.md documentation exists" || echo "⚠ CLAUDE.md not found (optional)"
          test -f docker-compose.yml && echo "✓ docker-compose.yml exists" || echo "⚠ docker-compose.yml not found (optional)"
          echo "All required structural checks passed!"

      - name: Check documentation
        run: |
          echo "Verifying documentation..."
          if grep -q "Street Parking Analyzer" CLAUDE.md; then
            echo "✓ CLAUDE.md contains project information"
          fi
          if [ -f README.md ]; then
            echo "✓ README.md exists"
          else
            echo "⚠ README.md not found (optional)"
          fi

      - name: Verify workflow files
        run: |
          echo "Checking workflow files..."
          test -f .github/workflows/backend-ci.yml && echo "✓ Backend CI workflow exists"
          test -f .github/workflows/frontend-ci.yml && echo "✓ Frontend CI workflow exists"
          test -f .github/workflows/ci.yml && echo "✓ Main CI workflow exists"

  lint-config-files:
    runs-on: ubuntu-latest
    name: Lint Configuration Files

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Validate YAML files
        run: |
          echo "Validating workflow YAML files..."
          for file in .github/workflows/*.yml; do
            echo "Checking $file..."
            python3 -c "import yaml; yaml.safe_load(open('$file'))" && echo "✓ Valid YAML" || echo "✗ Invalid YAML"
          done

      - name: Validate JSON files
        run: |
          echo "Validating JSON files..."
          if [ -f frontend/package.json ]; then
            python3 -c "import json; json.load(open('frontend/package.json'))" && echo "✓ frontend/package.json is valid JSON"
          fi
          if [ -f backend/pyproject.toml ]; then
            echo "✓ backend/pyproject.toml exists"
          fi

  security-check:
    runs-on: ubuntu-latest
    name: Security Scan

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check for secrets in code
        run: |
          echo "Scanning for potential secrets..."
          if grep -r "password\s*=\s*['\"]" --include="*.py" --include="*.js" --include="*.jsx" . ; then
            echo "⚠ Warning: Found hardcoded password-like strings"
          else
            echo "✓ No obvious hardcoded passwords found"
          fi
        continue-on-error: true

      - name: Check for API keys
        run: |
          echo "Scanning for API keys..."
          if grep -rE "(api_key|apikey|secret_key)\s*=\s*['\"][^'\"]{20,}" --include="*.py" --include="*.js" . ; then
            echo "⚠ Warning: Found potential API keys"
          else
            echo "✓ No obvious API keys found"
          fi
        continue-on-error: true
