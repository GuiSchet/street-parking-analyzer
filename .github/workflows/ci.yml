name: CI Pipeline

on:
  push:
    branches: [ main, develop, 'claude/**' ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:

jobs:
  detect-changes:
    runs-on: ubuntu-latest
    outputs:
      backend: ${{ steps.filter.outputs.backend }}
      frontend: ${{ steps.filter.outputs.frontend }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check for changes
        uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            backend:
              - 'backend/**'
              - '.github/workflows/backend-ci.yml'
              - '.github/workflows/ci.yml'
            frontend:
              - 'frontend/**'
              - '.github/workflows/frontend-ci.yml'
              - '.github/workflows/ci.yml'

  backend-ci:
    needs: detect-changes
    if: needs.detect-changes.outputs.backend == 'true' || github.event_name == 'workflow_dispatch'
    uses: ./.github/workflows/backend-ci.yml

  frontend-ci:
    needs: detect-changes
    if: needs.detect-changes.outputs.frontend == 'true' || github.event_name == 'workflow_dispatch'
    uses: ./.github/workflows/frontend-ci.yml

  integration-check:
    runs-on: ubuntu-latest
    needs: [backend-ci, frontend-ci]
    if: always() && (needs.backend-ci.result == 'success' || needs.backend-ci.result == 'skipped') && (needs.frontend-ci.result == 'success' || needs.frontend-ci.result == 'skipped')

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Verify project structure
        run: |
          echo "Checking project structure..."
          test -d backend && echo "✓ Backend directory exists"
          test -d frontend && echo "✓ Frontend directory exists"
          test -f backend/requirements.txt && echo "✓ Backend requirements.txt exists"
          test -f frontend/package.json && echo "✓ Frontend package.json exists"
          test -f CLAUDE.md && echo "✓ CLAUDE.md documentation exists"
          test -f docker-compose.yml && echo "✓ docker-compose.yml exists"
          echo "All structural checks passed!"

      - name: Check documentation
        run: |
          echo "Verifying documentation..."
          if grep -q "Street Parking Analyzer" CLAUDE.md; then
            echo "✓ CLAUDE.md contains project information"
          fi
          if [ -f README.md ]; then
            echo "✓ README.md exists"
          else
            echo "⚠ README.md not found (optional)"
          fi

  ci-status:
    runs-on: ubuntu-latest
    needs: [backend-ci, frontend-ci, integration-check]
    if: always()

    steps:
      - name: Check CI results
        run: |
          echo "Backend CI: ${{ needs.backend-ci.result }}"
          echo "Frontend CI: ${{ needs.frontend-ci.result }}"
          echo "Integration Check: ${{ needs.integration-check.result }}"

          if [[ "${{ needs.backend-ci.result }}" == "failure" ]] || [[ "${{ needs.frontend-ci.result }}" == "failure" ]]; then
            echo "❌ CI Pipeline failed"
            exit 1
          elif [[ "${{ needs.backend-ci.result }}" == "success" ]] || [[ "${{ needs.frontend-ci.result }}" == "success" ]]; then
            echo "✅ CI Pipeline passed"
            exit 0
          else
            echo "⏭️ CI Pipeline skipped (no changes detected)"
            exit 0
          fi
